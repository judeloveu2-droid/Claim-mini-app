<!DOCTYPE html>
<html lang="km">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ğŸ Daily Claim</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@300;400;500;600;700&family=Bebas+Neue&display=swap" rel="stylesheet">
<style>
  :root {
    --gold: #FFD700;
    --gold2: #FFA500;
    --dark: #0a0a1a;
    --card: #12122a;
    --card2: #1a1a35;
    --accent: #7c3aed;
    --accent2: #a855f7;
    --green: #10b981;
    --red: #ef4444;
    --teal: #06b6d4;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Kantumruy Pro', sans-serif;
    background: var(--dark);
    color: #e2e8f0;
    min-height: 100vh;
    overflow-x: hidden;
    user-select: none;
  }

  /* â•â•â•â•â•â•â•â•â•â• PAGES â•â•â•â•â•â•â•â•â•â• */
  .page { display: none; min-height: 100vh; flex-direction: column; }
  .page.active { display: flex; animation: fadeIn .4s ease; }
  @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:none; } }

  /* â•â•â•â•â•â•â•â•â•â• BACKGROUND â•â•â•â•â•â•â•â•â•â• */
  .bg-animated {
    position: fixed; inset: 0; z-index: -1;
    background: radial-gradient(ellipse at 20% 20%, #1a0a4a 0%, transparent 60%),
                radial-gradient(ellipse at 80% 80%, #0a2040 0%, transparent 60%),
                var(--dark);
  }
  .bg-animated::after {
    content: '';
    position: absolute; inset: 0;
    background-image: radial-gradient(circle, rgba(124,58,237,.08) 1px, transparent 1px);
    background-size: 32px 32px;
    animation: drift 20s linear infinite;
  }
  @keyframes drift { from { transform: translate(0,0); } to { transform: translate(32px,32px); } }

  /* â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• */
  .header {
    background: linear-gradient(135deg, #1a0a4a, #0a1a40);
    border-bottom: 1px solid rgba(124,58,237,.3);
    padding: 16px 20px;
    position: sticky; top: 0; z-index: 50;
  }

  /* â•â•â•â•â•â•â•â•â•â• BALANCE CARD â•â•â•â•â•â•â•â•â•â• */
  .balance-card {
    background: linear-gradient(135deg, #1e1060, #0f2060);
    border: 1px solid rgba(255,215,0,.25);
    border-radius: 20px;
    padding: 20px;
    position: relative; overflow: hidden;
  }
  .balance-card::before {
    content: ''; position: absolute; inset: 0;
    background: linear-gradient(45deg, transparent 40%, rgba(255,215,0,.05) 50%, transparent 60%);
    animation: shimmer 3s infinite;
  }
  @keyframes shimmer { 0%,100%{transform:translateX(-100%);} 50%{transform:translateX(100%);} }

  /* â•â•â•â•â•â•â•â•â•â• GIFT BOXES â•â•â•â•â•â•â•â•â•â• */
  .box-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; padding: 0 16px; }
  .gift-box {
    aspect-ratio: 1;
    background: linear-gradient(145deg, var(--card2), #0f0f2a);
    border: 2px solid rgba(124,58,237,.4);
    border-radius: 18px;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    cursor: pointer; position: relative; overflow: hidden;
    transition: transform .15s, border-color .15s, box-shadow .15s;
  }
  .gift-box:hover { transform: scale(1.04); border-color: var(--gold); box-shadow: 0 0 20px rgba(255,215,0,.3); }
  .gift-box.disabled { opacity:.4; cursor:not-allowed; pointer-events:none; }
  .gift-box.opened { pointer-events:none; }
  .gift-box .emoji { font-size: 2.4rem; transition: transform .3s; }
  .gift-box:hover .emoji { transform: scale(1.15) rotate(-5deg); }

  /* Shake animation */
  @keyframes shake {
    0%,100%{transform:rotate(0)}
    20%{transform:rotate(-8deg)}
    40%{transform:rotate(8deg)}
    60%{transform:rotate(-6deg)}
    80%{transform:rotate(6deg)}
  }
  .shake { animation: shake .5s ease-in-out; }

  /* Reveal animation */
  @keyframes revealBox {
    0%  { transform: scale(1);    filter: brightness(1); }
    30% { transform: scale(1.25); filter: brightness(1.6); }
    60% { transform: scale(0.9);  filter: brightness(1.2); }
    100%{ transform: scale(1.05); filter: brightness(1); }
  }
  .reveal { animation: revealBox .5s ease forwards; }

  /* Box win glow */
  .box-win  { border-color: var(--green) !important; box-shadow: 0 0 24px rgba(16,185,129,.5); }
  .box-jackpot { border-color: var(--gold) !important; box-shadow: 0 0 40px rgba(255,215,0,.8); animation: jackpotGlow 1s infinite alternate; }
  .box-empty { border-color: var(--red) !important; box-shadow: 0 0 20px rgba(239,68,68,.4); }
  @keyframes jackpotGlow {
    from { box-shadow: 0 0 30px rgba(255,215,0,.6); }
    to   { box-shadow: 0 0 60px rgba(255,165,0,1); }
  }

  /* â•â•â•â•â•â•â•â•â•â• RESULT MODAL â•â•â•â•â•â•â•â•â•â• */
  .modal-overlay {
    position: fixed; inset: 0; z-index: 100;
    background: rgba(0,0,0,.85); backdrop-filter: blur(8px);
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity .3s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal-sheet {
    background: linear-gradient(180deg, #1a0a4a 0%, #0a1020 100%);
    border: 1px solid rgba(124,58,237,.4);
    border-radius: 28px 28px 0 0;
    width: 100%; max-width: 480px;
    padding: 28px 24px 40px;
    transform: translateY(100%); transition: transform .4s cubic-bezier(.22,1,.36,1);
  }
  .modal-overlay.open .modal-sheet { transform: translateY(0); }

  /* â•â•â•â•â•â•â•â•â•â• NUMPAD â•â•â•â•â•â•â•â•â•â• */
  .numpad { display: grid; grid-template-columns: repeat(3,1fr); gap: 10px; }
  .numpad-btn {
    background: var(--card2);
    border: 1px solid rgba(124,58,237,.3);
    border-radius: 14px;
    padding: 18px 8px;
    font-size: 1.4rem; font-weight: 700;
    color: #e2e8f0; cursor: pointer;
    transition: background .12s, transform .1s, box-shadow .1s;
    font-family: 'Bebas Neue', sans-serif;
    letter-spacing: 1px;
  }
  .numpad-btn:active { transform: scale(.93); background: var(--accent); box-shadow: 0 0 14px rgba(124,58,237,.6); }
  .numpad-btn.delete { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.3); font-size:1rem; }
  .numpad-btn.submit { background: linear-gradient(135deg,var(--accent),var(--accent2)); border:none; color:#fff; font-size:.95rem; }
  .numpad-btn.submit:active { transform:scale(.93); }

  /* PIN dots */
  .pin-display { display: flex; gap: 10px; justify-content: center; margin: 16px 0; }
  .pin-dot {
    width: 42px; height: 42px;
    border-radius: 10px;
    background: var(--card2);
    border: 2px solid rgba(124,58,237,.3);
    display: flex; align-items: center; justify-content: center;
    font-size: 1.5rem; color: var(--gold);
    transition: all .15s;
  }
  .pin-dot.filled { background: rgba(124,58,237,.2); border-color: var(--accent); box-shadow: 0 0 10px rgba(124,58,237,.4); }

  /* â•â•â•â•â•â•â•â•â•â• COUNTDOWN â•â•â•â•â•â•â•â•â•â• */
  .countdown-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3.2rem; letter-spacing: 6px;
    background: linear-gradient(135deg, var(--gold), var(--gold2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    text-align: center;
  }

  /* â•â•â•â•â•â•â•â•â•â• BUTTONS â•â•â•â•â•â•â•â•â•â• */
  .btn-primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff; border: none; border-radius: 14px;
    padding: 14px 28px; font-size: 1rem; font-weight: 600;
    cursor: pointer; width: 100%;
    font-family: 'Kantumruy Pro', sans-serif;
    transition: transform .15s, box-shadow .15s;
    box-shadow: 0 4px 24px rgba(124,58,237,.4);
  }
  .btn-primary:active { transform: scale(.97); }
  .btn-gold {
    background: linear-gradient(135deg, #b8860b, var(--gold), #b8860b);
    color: #000; border: none; border-radius: 14px;
    padding: 14px 28px; font-size: 1rem; font-weight: 700;
    cursor: pointer; width: 100%;
    font-family: 'Kantumruy Pro', sans-serif;
    transition: transform .15s, box-shadow .15s;
    box-shadow: 0 4px 24px rgba(255,215,0,.4);
  }
  .btn-gold:active { transform: scale(.97); }

  /* â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â• */
  .loading-bar {
    height: 4px; border-radius: 4px;
    background: rgba(255,255,255,.1);
    overflow: hidden; position: relative;
  }
  .loading-fill {
    height: 100%; border-radius: 4px;
    background: linear-gradient(90deg, var(--accent), var(--gold), var(--accent));
    background-size: 200% 100%;
    animation: loadAnim 1s ease-out forwards, gradAnim 1s linear infinite;
  }
  @keyframes loadAnim { from{width:0} to{width:var(--target,100%)} }
  @keyframes gradAnim  { from{background-position:0%} to{background-position:200%} }

  /* â•â•â•â•â•â•â•â•â•â• CONFETTI â•â•â•â•â•â•â•â•â•â• */
  #confetti-canvas {
    position: fixed; inset: 0; z-index: 200;
    pointer-events: none;
  }

  /* â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â• */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--card2); border: 1px solid rgba(124,58,237,.4);
    border-radius: 14px; padding: 12px 24px;
    font-size: .95rem; color: #e2e8f0;
    transition: transform .3s ease; z-index: 300;
    white-space: nowrap; box-shadow: 0 8px 32px rgba(0,0,0,.5);
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  /* â•â•â•â•â•â•â•â•â•â• STICKER â•â•â•â•â•â•â•â•â•â• */
  .sticker-overlay {
    position: fixed; inset: 0; z-index: 150;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
  }
  .sticker-img {
    width: 200px; height: 200px; object-fit: contain;
    animation: stickerPop .6s cubic-bezier(.34,1.56,.64,1) forwards, stickerFade 1s .8s ease forwards;
    opacity: 0;
  }
  @keyframes stickerPop  { from{opacity:0;transform:scale(.3)} to{opacity:1;transform:scale(1)} }
  @keyframes stickerFade { from{opacity:1} to{opacity:0} }

  /* â•â•â•â•â•â•â•â•â•â• MISC â•â•â•â•â•â•â•â•â•â• */
  .tag {
    display: inline-block; border-radius: 8px; padding: 3px 10px;
    font-size: .75rem; font-weight: 600; letter-spacing: .5px;
  }
  .sound-toggle {
    background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15);
    border-radius: 50%; width: 36px; height: 36px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; font-size: 1.1rem; transition: background .15s;
  }
  .sound-toggle:active { background: rgba(255,255,255,.18); }
  .result-img { width: 100%; border-radius: 16px; max-height: 200px; object-fit: cover; }
  .spin-icon { display: inline-block; animation: spin 1s linear infinite; }
  @keyframes spin { to{ transform: rotate(360deg); } }
  ::-webkit-scrollbar { width: 4px; }
  ::-webkit-scrollbar-thumb { background: rgba(124,58,237,.4); border-radius: 4px; }
</style>
</head>
<body>

<div class="bg-animated"></div>
<canvas id="confetti-canvas"></canvas>
<div id="sticker-zone" class="sticker-overlay"></div>
<div id="toast" class="toast"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“„ PAGE 1: HOME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-home" class="page active">
  <!-- Header -->
  <div class="header flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="text-2xl">ğŸ</div>
      <div>
        <div class="font-bold text-base leading-tight">Daily Claim</div>
        <div class="text-xs text-purple-300">á áŸ’á‚áŸá˜á”áŸ’ášá…á¶áŸ†ááŸ’á„áŸƒ</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div id="sound-btn" class="sound-toggle" onclick="toggleSound()" title="Sound">ğŸ”Š</div>
    </div>
  </div>

  <!-- Content -->
  <div class="flex-1 overflow-y-auto pb-6" style="padding: 16px;">
    <!-- Balance Card -->
    <div class="balance-card mb-4">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs text-purple-300 uppercase tracking-widest">Balance</span>
        <span class="tag" style="background:rgba(255,215,0,.15);color:var(--gold)">ğŸ’° USD</span>
      </div>
      <div class="flex items-end gap-2">
        <div id="balance-display" class="text-4xl font-bold" style="font-family:'Bebas Neue';letter-spacing:2px;color:var(--gold)">$0.00</div>
      </div>
      <div class="mt-3 flex items-center gap-2">
        <div class="w-2 h-2 rounded-full bg-green-400" style="animation:pulse 2s infinite"></div>
        <span class="text-xs text-green-400" id="user-label">á€áŸ†á–á»á„á•áŸ’á‘á»á€...</span>
      </div>
    </div>

    <!-- Reward Info -->
    <div style="background:var(--card);border:1px solid rgba(124,58,237,.25);border-radius:16px;padding:16px;margin-bottom:16px;">
      <div class="text-sm font-semibold text-purple-300 mb-3">ğŸ“Š ášá„áŸ’áœá¶á“áŸ‹á€áŸ’á“á»á„á”áŸ’ášá¢á”áŸ‹</div>
      <div class="grid grid-cols-2 gap-2">
        <div class="flex items-center gap-2 text-sm"><span>ğŸ’µ</span><span class="text-green-400 font-bold">$0.05</span></div>
        <div class="flex items-center gap-2 text-sm"><span>ğŸ’¶</span><span class="text-blue-400 font-bold">$0.10</span></div>
        <div class="flex items-center gap-2 text-sm"><span>ğŸ’·</span><span class="text-yellow-400 font-bold">$0.20</span></div>
        <div class="flex items-center gap-2 text-sm"><span>ğŸ‘‘</span><span style="color:var(--gold)" class="font-bold">$0.80 <span class="text-xs opacity-60">(1%)</span></span></div>
      </div>
    </div>

    <!-- Status / CTA -->
    <div id="home-status" class="mb-4"></div>

    <!-- Claim Button -->
    <div id="claim-btn-wrap">
      <button id="claim-btn" class="btn-gold" onclick="startGame()">
        ğŸ á…á»á…áŠá¾á˜áŸ’á”á¸á›áŸá„
      </button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“„ PAGE 2: GAME BOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-game" class="page">
  <!-- Header -->
  <div class="header flex items-center justify-between">
    <button onclick="showPage('home')" class="flex items-center gap-2 text-purple-300">
      <span>â†</span> <span class="text-sm">ááŸ’ášá¡á”áŸ‹</span>
    </button>
    <div class="text-sm font-semibold">ğŸ á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá¢á”áŸ‹</div>
    <div id="sound-btn2" class="sound-toggle" onclick="toggleSound()">ğŸ”Š</div>
  </div>

  <!-- Loading bar -->
  <div id="loading-section" style="padding:16px;display:none;">
    <div class="text-center text-purple-300 text-sm mb-2" id="loading-text">ğŸ• Preparing reward boxes...</div>
    <div class="loading-bar">
      <div class="loading-fill" id="loading-fill" style="--target:0%;width:0%"></div>
    </div>
  </div>

  <!-- Game area -->
  <div id="game-area" class="flex-1 overflow-y-auto pb-6" style="padding:16px;display:none;">
    <div style="background:var(--card);border:1px solid rgba(124,58,237,.25);border-radius:16px;padding:14px;margin-bottom:16px;text-align:center;">
      <div class="text-sm text-purple-300">ğŸ«µğŸ» á‡áŸ’ášá¾áŸá”áŸ’ášá¢á”áŸ‹ <span class="font-bold text-white">áŸ¡</span> á€áŸ’á“á»á„á…áŸ†ááŸ„á˜ <span class="font-bold text-white">áŸ¦</span></div>
      <div class="text-xs text-slate-400 mt-1">â¤µï¸ á…á»á…á›á¾á”áŸ’ášá¢á”áŸ‹áá¶á˜á½á™</div>
    </div>
    <div class="box-grid" id="box-grid"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“„ PAGE 3: UNLOCK / NUMPAD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="page-unlock" class="page">
  <div class="header flex items-center justify-between">
    <button onclick="showPage('home')" class="flex items-center gap-2 text-purple-300">
      <span>â†</span> <span class="text-sm">ááŸ’ášá¡á”áŸ‹</span>
    </button>
    <div class="text-sm font-semibold">ğŸ” á”á‰áŸ’á…á¼á›á€á¼áŠ</div>
    <div style="width:36px"></div>
  </div>

  <div class="flex-1 overflow-y-auto pb-8" style="padding:16px;">
    <!-- Numpad header image -->
    <div style="border-radius:16px;overflow:hidden;margin-bottom:16px;height:140px;">
      <img src="https://i.postimg.cc/9F8g2XMt/59cf3d98704c322ce68cd33e0f4e1dee.jpg"
           style="width:100%;height:100%;object-fit:cover;" alt="Unlock">
    </div>

    <div style="background:var(--card);border:1px solid rgba(124,58,237,.3);border-radius:18px;padding:20px;margin-bottom:16px;">
      <div class="text-center mb-1 text-purple-300 text-sm">âŒ¨ï¸ á”á‰áŸ’á…á¼á›á€á¼áŠ Unlock áŸ¦ ááŸ’á‘á„áŸ‹</div>
      <div id="unlock-error" class="text-center text-red-400 text-sm mb-2" style="display:none;min-height:20px;"></div>

      <!-- PIN dots -->
      <div class="pin-display" id="pin-display">
        <div class="pin-dot" data-i="0">_</div>
        <div class="pin-dot" data-i="1">_</div>
        <div class="pin-dot" data-i="2">_</div>
        <div class="pin-dot" data-i="3">_</div>
        <div class="pin-dot" data-i="4">_</div>
        <div class="pin-dot" data-i="5">_</div>
      </div>

      <!-- Numpad -->
      <div class="numpad" id="numpad">
        <button class="numpad-btn" onclick="pinPress('1')">1</button>
        <button class="numpad-btn" onclick="pinPress('2')">2</button>
        <button class="numpad-btn" onclick="pinPress('3')">3</button>
        <button class="numpad-btn" onclick="pinPress('4')">4</button>
        <button class="numpad-btn" onclick="pinPress('5')">5</button>
        <button class="numpad-btn" onclick="pinPress('6')">6</button>
        <button class="numpad-btn" onclick="pinPress('7')">7</button>
        <button class="numpad-btn" onclick="pinPress('8')">8</button>
        <button class="numpad-btn" onclick="pinPress('9')">9</button>
        <button class="numpad-btn delete" onclick="pinDelete()">âŒ« á›á»á”</button>
        <button class="numpad-btn" onclick="pinPress('0')">0</button>
        <button class="numpad-btn submit" onclick="pinSubmit()" id="submit-btn">â˜‘ï¸ á”á‰áŸ’á‡á¶á€áŸ‹</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ“„ RESULT MODAL (Bottom Sheet)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="result-modal" class="modal-overlay" onclick="closeResult(event)">
  <div class="modal-sheet" onclick="event.stopPropagation()">
    <div id="result-drag" style="width:40px;height:4px;background:rgba(255,255,255,.2);border-radius:4px;margin:0 auto 20px;"></div>
    <img id="result-img" class="result-img" src="" alt="" style="margin-bottom:16px;display:none;">
    <div id="result-icon" class="text-center text-5xl mb-3"></div>
    <div id="result-title" class="text-center font-bold text-xl mb-2"></div>
    <div id="result-body" class="text-center text-slate-300 text-sm mb-6 leading-relaxed"></div>
    <div id="result-balance" class="text-center mb-5" style="font-family:'Bebas Neue';font-size:1.5rem;color:var(--gold);display:none;"></div>
    <button class="btn-primary" onclick="closeResult()">âœ… á™á›áŸ‹á–áŸ’ášá˜</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ğŸ”Š SOUND ENGINE (Web Audio API)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”Š SOUND SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let audioCtx = null;
let soundEnabled = true;
let bgmNode = null;
let bgmGain = null;

function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  if (audioCtx.state === 'suspended') audioCtx.resume();
  return audioCtx;
}

function toggleSound() {
  soundEnabled = !soundEnabled;
  document.getElementById('sound-btn').textContent  = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  document.getElementById('sound-btn2').textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
  if (!soundEnabled && bgmNode) { bgmGain.gain.setTargetAtTime(0, audioCtx.currentTime, .3); }
  else if (soundEnabled) { startBGM(); }
}

// â”€â”€ BGM (ambient loop) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startBGM() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  if (bgmNode) { try { bgmNode.stop(); } catch{} }

  // Create ambient pad: multiple detuned oscillators
  bgmGain = ctx.createGain();
  bgmGain.gain.value = 0.06;
  bgmGain.connect(ctx.destination);

  const notes = [261.63, 329.63, 392.00, 523.25]; // C E G C
  notes.forEach((freq, i) => {
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = 'sine';
    osc.frequency.value = freq;
    osc.detune.value = (i % 2 === 0 ? -4 : 4); // slight chorus
    g.gain.value = 0.25;
    osc.connect(g); g.connect(bgmGain);
    osc.start();
    // Slow vibrato
    const lfo = ctx.createOscillator();
    lfo.frequency.value = 0.3 + i * 0.05;
    const lfoG = ctx.createGain();
    lfoG.gain.value = 3;
    lfo.connect(lfoG); lfoG.connect(osc.detune);
    lfo.start();
  });
}

// â”€â”€ Click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playClick() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const g   = ctx.createGain();
  osc.type = 'sine'; osc.frequency.value = 900;
  g.gain.setValueAtTime(0.18, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.08);
  osc.connect(g); g.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + 0.08);
}

// â”€â”€ Numpad key â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playNumpad() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const g   = ctx.createGain();
  osc.type = 'triangle'; osc.frequency.value = 750;
  g.gain.setValueAtTime(0.14, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.06);
  osc.connect(g); g.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + 0.06);
}

// â”€â”€ Opening / Whoosh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playWhoosh() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  const buf = ctx.createBuffer(1, ctx.sampleRate * .5, ctx.sampleRate);
  const d   = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
  const src = ctx.createBufferSource();
  src.buffer = buf;
  const flt = ctx.createBiquadFilter();
  flt.type = 'bandpass'; flt.frequency.value = 1800; flt.Q.value = .8;
  const g = ctx.createGain();
  g.gain.setValueAtTime(0.4, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + .5);
  src.connect(flt); flt.connect(g); g.connect(ctx.destination);
  src.start();
}

// â”€â”€ Success / Win â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playSuccess() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  const freqs = [523.25, 659.25, 783.99, 1046.50];
  freqs.forEach((f, i) => {
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = 'sine'; osc.frequency.value = f;
    const t = ctx.currentTime + i * .1;
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(0.22, t + .04);
    g.gain.exponentialRampToValueAtTime(0.001, t + .4);
    osc.connect(g); g.connect(ctx.destination);
    osc.start(t); osc.stop(t + .45);
  });
}

// â”€â”€ Jackpot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playJackpot() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  // Fanfare: rapid ascending arpeggios
  const melody = [523,659,784,1047,1319,1568,2093];
  melody.forEach((f, i) => {
    const osc = ctx.createOscillator();
    const g   = ctx.createGain();
    osc.type = 'sawtooth'; osc.frequency.value = f;
    const t = ctx.currentTime + i * .09;
    g.gain.setValueAtTime(0, t);
    g.gain.linearRampToValueAtTime(0.18, t + .03);
    g.gain.exponentialRampToValueAtTime(0.001, t + .5);
    osc.connect(g); g.connect(ctx.destination);
    osc.start(t); osc.stop(t + .6);
  });
  // Coin shower sound
  setTimeout(() => {
    for (let i = 0; i < 12; i++) {
      setTimeout(() => {
        const o = ctx.createOscillator();
        const gn = ctx.createGain();
        o.frequency.value = 900 + Math.random() * 600;
        o.type = 'sine';
        gn.gain.setValueAtTime(0.12, ctx.currentTime);
        gn.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + .1);
        o.connect(gn); gn.connect(ctx.destination);
        o.start(); o.stop(ctx.currentTime + .1);
      }, i * 80);
    }
  }, 600);
}

// â”€â”€ Fail / Bomb â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function playFail() {
  if (!soundEnabled) return;
  const ctx = getAudioCtx();
  // Low thud
  const osc = ctx.createOscillator();
  const g   = ctx.createGain();
  osc.type = 'sawtooth';
  osc.frequency.setValueAtTime(180, ctx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(40, ctx.currentTime + .4);
  g.gain.setValueAtTime(0.5, ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + .5);
  osc.connect(g); g.connect(ctx.destination);
  osc.start(); osc.stop(ctx.currentTime + .5);
  // Noise burst
  const buf = ctx.createBuffer(1, ctx.sampleRate * .3, ctx.sampleRate);
  const d = buf.getChannelData(0);
  for (let i = 0; i < d.length; i++) d[i] = (Math.random() * 2 - 1) * (1 - i / d.length);
  const src = ctx.createBufferSource(); src.buffer = buf;
  const g2 = ctx.createGain(); g2.gain.value = 0.3;
  src.connect(g2); g2.connect(ctx.destination);
  src.start(); 
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŠ CONFETTI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const confCanvas = document.getElementById('confetti-canvas');
const confCtx    = confCanvas.getContext('2d');
let confetti = [], confRunning = false;

function startConfetti(duration = 3000) {
  confCanvas.width  = window.innerWidth;
  confCanvas.height = window.innerHeight;
  confetti = [];
  for (let i = 0; i < 140; i++) {
    confetti.push({
      x: Math.random() * confCanvas.width,
      y: Math.random() * confCanvas.height - confCanvas.height,
      w: Math.random() * 10 + 5,
      h: Math.random() * 6 + 3,
      color: ['#FFD700','#FFA500','#7c3aed','#06b6d4','#10b981','#f59e0b','#ec4899'][Math.floor(Math.random()*7)],
      vx: Math.random() * 3 - 1.5,
      vy: Math.random() * 4 + 2,
      rot: Math.random() * 360,
      vr: Math.random() * 6 - 3,
    });
  }
  confRunning = true;
  const end = Date.now() + duration;
  function loop() {
    confCtx.clearRect(0, 0, confCanvas.width, confCanvas.height);
    confetti.forEach(c => {
      c.x += c.vx; c.y += c.vy; c.rot += c.vr;
      confCtx.save();
      confCtx.translate(c.x + c.w/2, c.y + c.h/2);
      confCtx.rotate(c.rot * Math.PI / 180);
      confCtx.fillStyle = c.color;
      confCtx.fillRect(-c.w/2, -c.h/2, c.w, c.h);
      confCtx.restore();
    });
    if (Date.now() < end) requestAnimationFrame(loop);
    else { confCtx.clearRect(0, 0, confCanvas.width, confCanvas.height); confRunning = false; }
  }
  loop();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“³ HAPTIC FEEDBACK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haptic(type = 'light') {
  if (!window.Telegram?.WebApp?.HapticFeedback) {
    if (navigator.vibrate) {
      const map = { light: [30], medium: [60], heavy: [100,50,100], success: [50,30,80], fail: [200] };
      navigator.vibrate(map[type] || [30]);
    }
    return;
  }
  const h = window.Telegram.WebApp.HapticFeedback;
  if (type === 'success') h.notificationOccurred('success');
  else if (type === 'fail')  h.notificationOccurred('error');
  else h.impactOccurred(type);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, duration = 2500) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“„ PAGE NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(name) {
  playClick(); haptic('light');
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(`page-${name}`).classList.add('active');
  window.scrollTo(0, 0);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸŒ API HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const API_BASE = '';   // â† á”áŸ’ášáŸá·á“á”á¾ backend run locally: 'http://localhost:5000'
let initData = '';

async function apiPost(endpoint, body = {}) {
  const res = await fetch(API_BASE + endpoint, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-Telegram-Init-Data': initData,
    },
    body: JSON.stringify({ ...body, initData }),
  });
  return res.json();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ  HOME INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser   = null;
let cooldownTimer = null;
let cooldownSecs  = 0;

async function initApp() {
  // Init Telegram WebApp
  if (window.Telegram?.WebApp) {
    window.Telegram.WebApp.ready();
    window.Telegram.WebApp.expand();
    initData = window.Telegram.WebApp.initData || '';
  }

  try {
    const [userRes, statusRes] = await Promise.all([
      apiPost('/api/user'),
      apiPost('/api/claim_status'),
    ]);

    if (userRes.success) {
      currentUser = userRes;
      document.getElementById('balance-display').textContent = `$${userRes.balance.toFixed(2)}`;
      document.getElementById('user-label').textContent = `ğŸ‘¤ ${userRes.first_name}${userRes.username ? ' (@' + userRes.username + ')' : ''}`;
    }

    if (statusRes.success) {
      if (statusRes.can_claim) {
        showHomeReady();
      } else {
        startCooldownUI(statusRes.cooldown_remaining);
      }
    }
  } catch(e) {
    // Fallback for no-server testing
    currentUser = { first_name: 'TestUser', username: 'test', balance: 0 };
    document.getElementById('user-label').textContent = 'ğŸ‘¤ TestUser (Demo Mode)';
    showHomeReady();
  }

  // Start BGM after user interaction
  document.addEventListener('click', () => { if (soundEnabled) startBGM(); }, { once: true });
}

function showHomeReady() {
  clearInterval(cooldownTimer);
  document.getElementById('home-status').innerHTML = `
    <div style="background:rgba(16,185,129,.1);border:1px solid rgba(16,185,129,.3);border-radius:14px;padding:14px;text-align:center;margin-bottom:12px;">
      <div class="text-2xl mb-1">âœ…</div>
      <div class="font-semibold text-green-400">á¢áŸ’á“á€á¢á¶á…á›áŸá„á”á¶á“!</div>
      <div class="text-xs text-slate-400 mt-1">á…á»á…á”áŸŠá¼áá»á„áá¶á„á€áŸ’ášáŸ„á˜</div>
    </div>`;
  document.getElementById('claim-btn').disabled = false;
  document.getElementById('claim-btn').textContent = 'ğŸ á…á»á…áŠá¾á˜áŸ’á”á¸á›áŸá„';
  document.getElementById('claim-btn').className = 'btn-gold';
}

function startCooldownUI(remaining) {
  cooldownSecs = Math.ceil(remaining);
  document.getElementById('claim-btn').disabled = true;
  document.getElementById('claim-btn').textContent = 'â³ Cooldown...';
  document.getElementById('claim-btn').className = 'btn-primary';

  function renderCountdown() {
    const h = String(Math.floor(cooldownSecs / 3600)).padStart(2,'0');
    const m = String(Math.floor((cooldownSecs % 3600) / 60)).padStart(2,'0');
    const s = String(cooldownSecs % 60).padStart(2,'0');
    document.getElementById('home-status').innerHTML = `
      <div style="background:rgba(124,58,237,.1);border:1px solid rgba(124,58,237,.3);border-radius:14px;padding:14px;text-align:center;margin-bottom:12px;">
        <div class="text-sm text-purple-300 mb-2">ğŸ•¦ á–áŸá›áœáŸá›á¶ášá„áŸ‹á…á¶áŸ†</div>
        <div class="countdown-display">${h}:${m}:${s}</div>
        <div class="text-xs text-slate-400 mt-2">á…á„áŸ‹á›áŸá„á”á“áŸ’á? á…á»á… Unlock áá¶á„á€áŸ’ášáŸ„á˜</div>
      </div>
      <button class="btn-primary mb-3" onclick="showPage('unlock');playClick();">ğŸ”“ Unlock áŠáŸ„á™á”áŸ’ášá¾á€á¼áŠ</button>
    `;
  }

  renderCountdown();
  cooldownTimer = setInterval(() => {
    cooldownSecs--;
    if (cooldownSecs <= 0) { clearInterval(cooldownTimer); showHomeReady(); }
    else renderCountdown();
  }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ® GAME LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentRewards = [];

async function startGame() {
  playClick(); haptic('medium');
  showPage('game');

  // Loading sequence
  const loadingSection = document.getElementById('loading-section');
  const gameArea       = document.getElementById('game-area');
  const loadingText    = document.getElementById('loading-text');
  const fill           = document.getElementById('loading-fill');

  loadingSection.style.display = 'block';
  gameArea.style.display = 'none';

  const steps = [
    { text: 'ğŸ• Preparing reward boxes...', pct: 20, delay: 500 },
    { text: 'ğŸ¥™ Shuffling rewards... 40%',  pct: 50, delay: 400 },
    { text: 'ğŸ”„ Adding Jackpot... 70%',      pct: 80, delay: 400 },
    { text: 'â˜‘ï¸ Ready!',                     pct: 100, delay: 300 },
  ];

  for (const step of steps) {
    loadingText.textContent = step.text;
    fill.style.setProperty('--target', step.pct + '%');
    fill.style.width = step.pct + '%';
    playWhoosh();
    await sleep(step.delay);
  }

  // Fetch rewards from API
  let rewards;
  try {
    const res = await apiPost('/api/play_game');
    if (!res.success) {
      if (res.error === 'cooldown') {
        showPage('home');
        startCooldownUI(res.cooldown_remaining);
        return;
      }
      throw new Error(res.error);
    }
    rewards = res.rewards;
  } catch(e) {
    // Demo fallback
    rewards = generateDemoRewards();
  }

  currentRewards = rewards;
  loadingSection.style.display = 'none';
  buildBoxGrid();
  gameArea.style.display = 'block';
}

function generateDemoRewards() {
  const r = [0.0, 0.0, 0.0, 0.05, 0.10, 0.20];
  if (Math.random() < .01) r[Math.floor(Math.random()*3)+3] = 0.80;
  return r.sort(() => Math.random() - .5);
}

function buildBoxGrid() {
  const grid = document.getElementById('box-grid');
  grid.innerHTML = '';
  for (let i = 0; i < 6; i++) {
    const box = document.createElement('div');
    box.className = 'gift-box';
    box.dataset.index = i;
    box.innerHTML = `<div class="emoji">ğŸ</div><div style="font-size:.65rem;color:rgba(255,255,255,.4);margin-top:4px;">á”áŸ’ášá¢á”áŸ‹ ${i+1}</div>`;
    box.onclick = () => openBox(i, box);
    grid.appendChild(box);
  }
}

async function openBox(index, boxEl) {
  if (boxEl.classList.contains('opened') || boxEl.classList.contains('disabled')) return;
  playClick(); haptic('medium');

  // Disable all boxes
  document.querySelectorAll('.gift-box').forEach(b => b.classList.add('disabled'));

  // Shake animation
  boxEl.classList.add('shake');
  await sleep(200);
  playWhoosh();
  await sleep(300);
  boxEl.classList.remove('shake');

  // Reveal
  boxEl.classList.add('reveal');

  let result;
  try {
    result = await apiPost('/api/open_box', { box_index: index, rewards: currentRewards });
  } catch(e) {
    // Demo fallback
    const amount = currentRewards[index];
    result = {
      success: true, amount,
      result_type: amount === 0.80 ? 'jackpot' : (amount > 0 ? 'win' : 'empty'),
      image_url: amount === 0.80
        ? 'https://i.postimg.cc/BZNqfDGX/a547b6eb4b4e4ed4f76c97b674c46e7f.jpg'
        : amount > 0
          ? 'https://i.postimg.cc/VLj2cPt2/24601b5a4237a55e6bb48e72626021a3.jpg'
          : 'https://i.postimg.cc/rw1xqQy4/93a0ba286bb43122953ee1f2067af107.jpg',
      new_balance: (currentUser?.balance || 0) + (amount > 0 ? amount : 0),
    };
  }

  await sleep(300);
  boxEl.classList.add('opened');

  // Show result UI based on type
  if (result.result_type === 'jackpot') {
    boxEl.classList.add('box-jackpot');
    boxEl.querySelector('.emoji').textContent = 'ğŸ‘‘';
    playJackpot(); haptic('heavy');
    startConfetti(5000);
    await sleep(400);
    showResultModal({
      icon: 'ğŸ‘‘',
      title: 'JACKPOT WINNER!',
      titleColor: 'var(--gold)',
      body: `ğŸŠ á¢á”á¢ášáŸá¶á‘áš! á¢áŸ’á“á€áˆáŸ’á“áŸ‡á”áŸ’ášá¢á”áŸ‹ Jackpot!\nğŸ’° á‘á‘á½á›á”á¶á“: $${result.amount.toFixed(2)} USD\nâ­ Rate: 1% â€” á–á·áŸáŸáŸá”áŸ†á•á»á!`,
      image: result.image_url,
      balance: result.new_balance,
    });

  } else if (result.result_type === 'win') {
    boxEl.classList.add('box-win');
    const emoji = result.amount === 0.05 ? 'ğŸ’µ' : result.amount === 0.10 ? 'ğŸ’¶' : 'ğŸ’·';
    boxEl.querySelector('.emoji').textContent = emoji;
    playSuccess(); haptic('success');
    startConfetti(2500);
    await sleep(400);
    showResultModal({
      icon: emoji,
      title: 'WINNER! ğŸŠ',
      titleColor: '#10b981',
      body: `ğŸ¥³ á¢áŸ’á“á€áˆáŸ’á“áŸ‡ášá„áŸ’áœá¶á“áŸ‹!\nğŸ’° á‘á‘á½á›á”á¶á“: $${result.amount.toFixed(2)} USD\nğŸ“Š áŸáŸ’áá¶á“á—á¶á–: á”á‰áŸ’á…á¼á›á‡áŸ„á‚á‡áŸá™`,
      image: result.image_url,
      balance: result.new_balance,
    });

  } else {
    boxEl.classList.add('box-empty');
    boxEl.querySelector('.emoji').textContent = 'ğŸ’¨';
    playFail(); haptic('fail');
    await sleep(400);
    showResultModal({
      icon: 'âŒ',
      title: 'Better Luck Next Time!',
      titleColor: '#ef4444',
      body: 'ğŸ“¦ á”áŸ’ášá¢á”áŸ‹á‘á‘áŸ â€” áŸáŸ’á¢á»á™!\nğŸ•¦ Cooldown: áŸ¢áŸ¤ á˜áŸ‰áŸ„á„\nğŸ”„ á–áŸ’á™á¶á™á¶á˜á˜áŸ’áŠá„á‘áŸ€áááŸ’á„áŸƒáŸáŸ’á¢áŸ‚á€',
      image: result.image_url,
      balance: null,
    });
    // start cooldown on home
    setTimeout(() => startCooldownUI(86400), 1500);
  }

  // Update balance display
  if (result.new_balance !== undefined && currentUser) {
    currentUser.balance = result.new_balance;
    document.getElementById('balance-display').textContent = `$${result.new_balance.toFixed(2)}`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ“‹ RESULT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showResultModal({ icon, title, titleColor, body, image, balance }) {
  document.getElementById('result-icon').textContent  = icon;
  document.getElementById('result-title').textContent = title;
  document.getElementById('result-title').style.color = titleColor;
  document.getElementById('result-body').textContent  = body;

  const img = document.getElementById('result-img');
  if (image) { img.src = image; img.style.display = 'block'; }
  else img.style.display = 'none';

  const balEl = document.getElementById('result-balance');
  if (balance !== null && balance !== undefined) {
    balEl.textContent = `ğŸ’° Balance: $${balance.toFixed(2)}`;
    balEl.style.display = 'block';
  } else balEl.style.display = 'none';

  document.getElementById('result-modal').classList.add('open');
}

function closeResult(e) {
  if (e && e.target !== document.getElementById('result-modal')) return;
  document.getElementById('result-modal').classList.remove('open');
  playClick();
  showPage('home');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ” NUMPAD / UNLOCK
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let pin = '';

function updatePinDisplay() {
  document.querySelectorAll('#pin-display .pin-dot').forEach((dot, i) => {
    if (i < pin.length) { dot.textContent = 'â˜…'; dot.classList.add('filled'); }
    else { dot.textContent = '_'; dot.classList.remove('filled'); }
  });
}

function pinPress(digit) {
  if (pin.length >= 6) return;
  playNumpad(); haptic('light');
  pin += digit;
  updatePinDisplay();
}

function pinDelete() {
  if (!pin.length) return;
  playClick(); haptic('light');
  pin = pin.slice(0, -1);
  updatePinDisplay();
  document.getElementById('unlock-error').style.display = 'none';
}

async function pinSubmit() {
  if (pin.length !== 6) { showToast('âš ï¸ áŸá¼á˜á”á‰áŸ’á…á¼á›á€á¼áŠ áŸ¦ ááŸ’á‘á„áŸ‹!'); haptic('fail'); return; }
  playClick(); haptic('medium');

  const btn = document.getElementById('submit-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin-icon">âŸ³</span> á€áŸ†á–á»á„á–á·á“á·ááŸ’á™...';

  const errEl = document.getElementById('unlock-error');
  errEl.style.display = 'none';

  try {
    const res = await apiPost('/api/verify_unlock', { key_code: pin });
    if (res.success) {
      playSuccess(); haptic('success');
      showToast('âœ… Unlock á‡áŸ„á‚á‡áŸá™! á¢áŸ’á“á€á¢á¶á…á›áŸá„á—áŸ’á›á¶á˜áŸ—');
      pin = ''; updatePinDisplay();
      clearInterval(cooldownTimer);
      setTimeout(() => { showPage('home'); showHomeReady(); }, 1200);
    } else {
      playFail(); haptic('fail');
      errEl.textContent = 'âŒ ' + (res.error || 'á€á¼áŠáá»áŸ!');
      errEl.style.display = 'block';
      pin = ''; updatePinDisplay();
    }
  } catch(e) {
    errEl.textContent = 'âŒ Demo Mode â€” Backend á˜á·á“á‘á¶á“áŸ‹ Run';
    errEl.style.display = 'block';
    pin = ''; updatePinDisplay();
  }

  btn.disabled = false;
  btn.innerHTML = 'â˜‘ï¸ á”á‰áŸ’á‡á¶á€áŸ‹';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ›  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸš€ BOOT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', initApp);
window.addEventListener('resize', () => {
  if (confCanvas) { confCanvas.width = window.innerWidth; confCanvas.height = window.innerHeight; }
});
</script>
</body>
</html>
